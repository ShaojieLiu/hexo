---
title: 加密货币原理
date: 2019-03-25 19:53:32
tags: crypto
---

# Reference

[参考视频 1](https://v.youku.com/v_show/id_XMzY3MjIzMTczMg==.html?spm=a2hzp.8244740.0.0)
[参考视频](https://www.youtube.com/watch?v=bBC-nXj3Ng4&t=1301s)
[区块链产业园](http://www.sohu.com/a/237304390_100067312)

# 引子

加密货币的市场

{% asset_img coinList.png 加密货币排行 %}

加密货币的大佬

{% asset_img wjh.png 吴忌寒 %}

> [吴忌寒：从倾家荡产到身价百亿只用了 8 年](https://finance.sina.com.cn/blockchain/roll/2019-01-04/doc-ihqfskcn3954611.shtml)
> 吴忌寒先生，一个在币圈当之无愧的殿堂级人物，85 后，北大毕业，心理学和经济学双学位，是他对外常见的标签。目前担任比特大陆 CEO 一职，系业内公认的比特币布道者，早在 2011 年就接触到了比特币，与长铗等人一同创立了巴比特，之后创建了矿机芯片公司比特大陆。从 2013 年年底开始，吴忌寒逐渐不再活跃于比特币社区，成为比特币圈内最为神秘的大佬之一。比特大陆是一个涵盖矿机、矿池、矿场、交易平台等全方面的币圈巨擘。其中，旗下比特币矿池蚁池(AntPool)是目前世界上最大的比特币矿池。该矿池占有行业 20%的算力，是比特币世界的巨头之一。由此可知，吴忌寒被誉为比特币界的霸主，绝对不是空穴来风。

加密货币的政策

现在全国各地的区块链产业园如雨后春笋:

- 上海智力产业园天空区块链孵化基地
- 杭州区块链产业园, 西溪谷互联网金融小镇, 杭州萧山区规划的万向创新聚能城
- 广州越秀区的国际区块链产业园和《广州市黄埔区广州市开发区促进区块链产业发展办法》
- 武汉区块链产业园
- 重庆市经济和信息化委员会下发的《关于加快区块链产业培育及创新应用的意见》(2017)
- 青岛确立了“一楼（区块链大厦）、一院（区块链产业研究院）、五平台、十大应用”的发展蓝图
- 苏州同济金融科技研究院
- 江西赣州区块链金融产业沙盒园
- 湖南娄底国家级区块链研究和应用示范区
- 海南海口, 广西, 辽宁

那么加密货币的原理是什么呢? 阅读本文你将了解以下基础概念:

- 数字签名
- 去中心化(分布式账本)
- 工作量证明(POW)
- 区块链

# 从分布式账本说起

> 加密货币 = 加密算法 + 分布式账本

我们先来解决一个很实际的小问题.

假如你和你的三个朋友有频繁的金钱往来, 为了避免现金实时结算带来烦恼, 你们可能会使用一个账本来记录一切未结算的金钱往来.

{% asset_img ledger.png 独立账本 %}

账本的协议如下:

1. 任何人都可以往账本上添加记录
1. 每条记录都需要有效的签名
1. 不能"超花"(使一方的余额变成负数)

## 数字签名

那么我们如何校验数据的合法性呢? 这时候需要数字签名.

一个纸质的账本, 我们可以使用独特的手写笔迹来确认交易记录的合法性. 那么一个数字记录可能没这么直接.

{% asset_img sign0.png 纸质签名 %}

因为你很容易想到, 无论我的签名是多么的独特和高辨识度, 只要它是不改变的, 在计算机上我总可以复制一份一模一样的数据出来.

{% asset_img sign1.png 签名复制 %}

这里面使用了密码学的知识, 需要以下四个概念来理解: 私钥, 公钥, 签名函数, 验证函数. 他们的关系如下图表述:

{% asset_img key0.png 数字签名 %}

它保证了, 没有私钥的人无法得到一个正确的签名. 因此签名通过验证函数时, 你可以确定这个签名是由当事人使用私钥计算出来的, 并且每个签名都是独特的.

## 账本规则的维护

1. 所以我们需要让某一个人持有这个账本(只有他可以写入), 这个账本放在谁那里好呢? 拥有这个账本的人拥有极大的权力, 所以必须是一个所有人都信任的人, 而且必须是没有利益相关的. 这个模式我们称之为第三方账本, 目前广泛应用, 例如常用的银行, 支付宝, 都是属于大家信任的第三方机构.

2. 还有一种模式, 就是每个人都有一个账本, 每个人都可以在上面增加信息, 然后互相之间同步账本, 这种模式称为"分布式账本".

## 矿工

> 什么是矿工呢?
> 难道他们不停地挖矿吗?
> {% asset_img miner0.png 矿工挖矿 %}
> 并非如此, 他们使用区块内的所有字符串作为输入(包括它所猜的数字)进行 SHA256 计算, 当结果符合一定条件时(例如开头是 30 个零), 即为成功. 你现在一定有很多疑问, 区块内包含了什么, 他为什么要猜数字, 为什么要不停地进行 hash 计算? 接下来的阅读或许可以为你带来解答.

{% asset_img miner1.png 数字矿机挖矿 %}

## 禁止超花

假如某个人赊账很多之后跑路, 会对整个记账体系造成伤害. 为了避免这样的事情, 我们需要规定: 每个人账上初始资金为 0, 通过预付资金来获得付账的能力, 然后再规定每一条记录不能使得付款者的资金变为负数, 也就是禁止超花.

账本在添加新纪录的时候需要回溯付款方的所有历史交易记录, 从而得到当前交易记录是否"超花".
"超花"和没有数字签名一样都是不合法的记录.

{% asset_img currency0.png currency %}
所以本质上讲, 每一个数字货币都是一个账本, 而账本里的所有交易记录就可以体现你的当前余额.

{% asset_img overspand.png 超花是非法的 %}

这条规定在实际上, 使得账上的支付能力脱离了与实际货币的绑定关系, 使得支付能力与实际货币之间可以进行交易, 形成一个交易对. 为了方便起见, 我们需要给这种支付能力一个单位, 我们暂时称之为 LD(Ledger Dollar).

{% asset_img trade.png 不同的交易对 %}

## 如何维护账本规则?

我们现在有了完整的账本规则, 再来回顾一下:

1. 每个人都可以添加新的记录, 并且广播
2. 每个记录必须有支付者有效的数字签名
3. 每个记录必须确保支付者余额不为负数

那么谁来确保这些规则被有效地执行了呢?

# 分布式账本的难题

每个人都拥有一本账本, 当有新的记录添加的时候, 发起广播, 其他人来同步这个信息.

{% asset_img 分布式与广播.png 分布式与广播 %}

这里有一个难题: 所有的账本能做到一模一样么?

比如说, 由于网络原因, 某个账本遗漏了一些记录, 或者不同账本接收到的记录的顺序是不一样的(这会导致超花判定的不同).

其实早在 1982 年便有人提出基于密码学的网络支付系统, 但是上述的问题一直没有很好的解决办法.
直到 2008 年，中本聪在 metzdowd 上发表了一篇论文，该论文提供了这一难题的一种解法, 描述了比特币的电子现金系统。

以下我们来了解他是如何做的.

## POW

这种方法叫做"工作量证明"(proof of work, POW).

首先我们把一定数量的记录打包在一起, 称之为一个"区块", 多个区块以确定的顺序相连形成"区块链".

而这个解法的本质就是:

1. 提高创建区块的难度.
2. 在多链存在的情况下, 提供一个"共识"机制.

> Message = ledgerContent + yourGuessNumber
> SHA256(`${Message}`) = hash
> 当 hash 的前 30 位都是 0 时, yourGuessNumber 即为合法的.

{% asset_img POW.png POW %}

这个规则有以下特征:

1. 目前, 要得到合法的值只能靠猜, 概率很低, 约为 10 亿分之一.
1. 工作量与验证的不对称性: 得到合法的值很难, 而验证它合法很容易

## 区块链

当我们得到当前区块的合法 hash 之后, 我们会将这个 hash 放在下一个区块的头部.

{% asset_img chain.png chain %}

这样子, 区块与区块之间的顺序会被确定下来, 一旦有人对某个历史区块做了任意改动, 都会导致该历史区块的 hash 需要重新计算, 这样子下一区块的头部 hash 也需要变更, 就会导致整条链都需要重新计算. 而这个计算量非常巨大, 篡改历史数据的成本非常高, 所以我们说区块链具有不可篡改的特性.

说到这里不得不提一件事:
[北大学生公开信, 区块链没有"404"](https://www.bibaodao.com/industry/3066.html)
[公开信的地址](https://etherscan.io/tx/0x2d6a7b0f6adeff38423d4c62cd8b6ccb708ddad85da5d3d06756ad4d8a04a6a2)
信中提及了一位学生因为追究北大教授性侵案而遭到多方压力和封杀消息的悲惨经历, 不得已将公开信写在交易记录的备注之中上 ETH 区块链, 现在这封信永远无法被删除了.

## 矿工

因此, 现在我们的游戏里多了一个角色, 他们负责产生新区块.
由于这个角色很重要, 需要额外的奖励, 所以我们允许他在区块里除了听取到的交易记录外, 在增加一条记录"本矿工获得 10LD", 这条记录没有支付者, 因此也不需要签名, 这里的 10LD 是凭空产生的, 所以这种产生新区块的行为被称为"挖矿", 这个角色我们称之为"矿工".
矿工的工作如下:

1. 听取交易记录的广播并收集成为一个区块.
1. 在区块里新增一条记录.
1. 猜数字得到合法的 hash.
1. 广播出去.

从多个矿工的角度来看, 大家都在玩猜数字游戏, 当有一个矿工猜到了数字并广播出去之后, 其他矿工便会验证该广播的合法性, 若合法则停止猜数字, 并在新区块的头部添加上前一区块的 hash, 然后很不甘心地重新开始猜数字.

当玩家听到多条不同的区块链广播时, 越长的区块链所包含的工作量越大, 因此我们规定长的区块链是合法的.

{% asset_img longChain.png 长链即正义 %}

所以交易的确认是需要时间的:

1. 你需要等待你的交易被矿工打包成区块链
2. 你需要等待一段时间, 直到包含你交易的区块链达到足够的长度, 这时候你放心了, 因为:
3. 区块链是不能被篡改的
4. 这条链包含了许多工作量, 其他链的长度很难超过它

以上所提到的模型, 便是中本聪在论文中描述的.
使用这套方法, 本质上我们不再需要信任权威的第三方机构, 我们只信任计算量.

## POW 可靠吗?

{% asset_img attack.png 假链攻击 %}

关于假链攻击的生动的描述.

## 挖矿难度

我们先回顾一下本章所学的一些基本概念:

- 数字签名
- 去中心化(分布式账本)
- 工作量证明(POW)
- 区块链

刚刚我们在讲工作量证明时一直提到 30 个零, 其实也未必就必须是 30 个, 这个数值决定了挖矿行为的难度.
这个难度会根据全网的算力来进行调整, 以维持出块速度的稳定.

不同的数字货币的挖矿难度不尽相同, 因此他们的出块时间也不一样, 每秒钟能处理的交易数量也是不同的.

{% asset_img blockTime.png 平均出块时间 %}

另外, 由于挖矿奖励的币是凭空产生的, 为了防止通货膨胀, 所有的数字货币都有奖励减少的规则(例如比特币是每 4 年减半).

{% asset_img blockReward.png 比特币的区块奖励 %}

深谙数学的你便想到了, 这样子比特币的发行量是有上限的, 我们来计算一下.

> BTC 创世的时候发行量为 0
> BTC 出块速度约为 10 分钟
> 前 4 年出块量 = 60 \* 24 \* 365 / 10 \* 4 = 5.265w \* 4 = 21.06w
> 前 4 年发行量 = 前 4 年出块量 \* 50 = 1053w
> 总发行量 = 前 4 年发行量 \* 2 = 2106w

# 阅读更多科普文

1. [关于全节点和轻节点(默克尔树)]()
1. [如何购买我的第一个数字货币]()
1. [什么是硬分叉和软分叉: ETH 和 ETC 的故事]()
1. [除了支付区块链还能带来什么? --以太猫和 FOMO3D 趣闻录]()
1. [浅谈区块链中常见的共识机制]()
