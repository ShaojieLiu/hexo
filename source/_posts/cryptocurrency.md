---
title: 加密货币原理
date: 2019-03-25 19:53:32
tags: crypto
---

# Reference

[参考视频](https://v.youku.com/v_show/id_XMzY3MjIzMTczMg==.html?spm=a2hzp.8244740.0.0)
[区块链产业园](http://www.sohu.com/a/237304390_100067312)

# 引子

现在全国各地的区块链产业园如雨后春笋:
- 上海智力产业园天空区块链孵化基地
- 杭州区块链产业园, 西溪谷互联网金融小镇, 杭州萧山区规划的万向创新聚能城
- 广州越秀区的国际区块链产业园和《广州市黄埔区广州市开发区促进区块链产业发展办法》
- 武汉区块链产业园
- 重庆市经济和信息化委员会下发的《关于加快区块链产业培育及创新应用的意见》(2017)
- 青岛确立了“一楼（区块链大厦）、一院（区块链产业研究院）、五平台、十大应用”的发展蓝图
- 苏州同济金融科技研究院
- 江西赣州区块链金融产业沙盒园
- 湖南娄底国家级区块链研究和应用示范区
- 海南海口, 广西, 辽宁


# 从分布式账本说起

> 加密货币 = 加密算法 + 分布式账本 

我们先来解决一个很实际的小问题.

假如你和你的三个朋友有频繁的金钱往来, 为了避免现金实时结算带来烦恼, 你们可能会使用一个账本来记录一切未结算的金钱往来.
{% asset_img ledger.png 独立账本 %}
但是问题来了, 这个账本放在谁那里好呢? 拥有这个账本的人拥有极大的权力, 所以必须是一个所有人都信任的人, 而且必须是没有利益相关的.

这个模式目前广泛应用, 例如常用的银行, 支付宝, 都是属于大家信任的第三方机构.

### 矿工

> 什么是矿工呢?
> 难道他们不停地挖矿吗?
> {% asset_img miner0.png 矿工挖矿 %}
> 并非如此, 他们使用区块内的所有字符串作为输入(包括它所猜的数字)进行 SHA256 计算, 当结果符合一定条件时(例如开头是 30 个零), 即为成功. 你现在一定有很多疑问, 区块内包含了什么, 他为什么要猜数字, 为什么要不停地进行 hash 计算? 接下来的阅读或许可以为你带来解答.

{% asset_img miner1.png 数字矿机挖矿 %}

### 禁止超花

假如某个人赊账很多之后跑路, 会对整个记账体系造成伤害. 为了避免这样的事情, 我们需要规定: 每个人账上初始资金为0, 通过预付资金来获得付账的能力, 然后再规定每一条记录不能使得付款者的资金变为负数, 也就是禁止超花.

{% asset_img overspand.png 超花是非法的 %}

这条规定在实际上, 使得账上的支付能力脱离了与实际货币的绑定关系, 使得支付能力与实际货币之间可以进行交易, 形成一个交易对. 为了方便起见, 我们需要给这种支付能力一个单位, 我们暂时称之为LD(Ledger Dollar).

{% asset_img trade.png 不同的交易对 %}

### 如何维护账本规则?

我们现在有了完整的账本规则, 再来回顾一下:
1. 每个人都可以添加新的记录, 并且广播
2. 每个记录必须有支付者有效的数字签名
3. 每个记录必须确保支付者余额不为负数

那么谁来确保这些规则被有效地执行了呢?

# 分布式账本的难题

每个人都拥有一本账本, 当有新的记录添加的时候, 发起广播, 其他人来同步这个信息.

{% asset_img 分布式与广播.png 分布式与广播 %}

这里有一个难题: 所有的账本能做到一模一样么?

比如说, 由于网络原因, 某个账本遗漏了一些记录, 或者不同账本接收到的记录的顺序是不一样的(这会导致超花判定的不同).

其实早在1982年便有人提出基于密码学的网络支付系统, 但是上述的问题一直没有很好的解决办法.
直到2008年，中本聪在metzdowd上发表了一篇论文，该论文提供了这一难题的一种解法, 描述了比特币的电子现金系统。

以下我们来了解他是如何做的.

### POW

这种方法叫做"工作量证明"(proof of work, POW).

首先我们把一定数量的记录打包在一起, 称之为一个"区块", 多个区块以确定的顺序相连形成"区块链".

而这个解法的本质就是:
1. 提高创建区块的难度.
2. 在多链存在的情况下, 提供一个"共识"机制.

> Message = ledgerContent + yourGuessNumber
> SHA256(`${Message}`) = hash
> 当hash的前30位都是0时, yourGuessNumber即为合法的.

{% asset_img POW.png POW %}

这个规则有以下特征:
1. 目前, 要得到合法的值只能靠猜, 概率很低, 约为10亿分之一.
1. 工作量与验证的不对称性: 得到合法的值很难, 而验证它合法很容易

### 区块链

当我们得到当前区块的合法hash之后, 我们会将这个hash放在下一个区块的头部.

{% asset_img chain.png chain %}

这样子, 区块与区块之间的顺序会被确定下来, 一旦有人对某个历史区块做了任意改动, 都会导致该历史区块的hash需要重新计算, 这样子下一区块的头部hash也需要变更, 就会导致整条链都需要重新计算. 而这个计算量非常巨大, 篡改历史数据的成本非常高, 所以我们说区块链具有不可篡改的特性.

说到这里不得不提一件事: 
[北大学生公开信, 区块链没有"404"](https://www.bibaodao.com/industry/3066.html)
[公开信的地址](https://etherscan.io/tx/0x2d6a7b0f6adeff38423d4c62cd8b6ccb708ddad85da5d3d06756ad4d8a04a6a2)
信中提及了一位学生因为追究北大教授性侵案而遭到多方压力和封杀消息的悲惨经历, 不得已将公开信写在交易记录的备注之中上ETH区块链, 现在这封信永远无法被删除了.

### 矿工

因此, 现在我们的游戏里多了一个角色, 他们负责产生新区块.
由于这个角色很重要, 需要额外的奖励, 所以我们允许他在区块里除了听取到的交易记录外, 在增加一条记录"本矿工获得10LD", 这条记录没有支付者, 因此也不需要签名, 这里的10LD是凭空产生的, 所以这种产生新区块的行为被称为"挖矿", 这个角色我们称之为"矿工".
矿工的工作如下:
1. 听取交易记录的广播并收集成为一个区块.
1. 在区块里新增一条记录.
1. 猜数字得到合法的hash.
1. 广播出去.

从多个矿工的角度来看, 大家都在玩猜数字游戏, 当有一个矿工猜到了数字并广播出去之后, 其他矿工便会验证该广播的合法性, 若合法则停止猜数字, 并在新区块的头部添加上前一区块的hash, 然后很不甘心地重新开始猜数字.

当玩家听到多条不同的区块链广播时, 越长的区块链所包含的工作量越大, 因此我们规定长的区块链是合法的.

{% asset_img longChain.png 长链即正义 %}

所以交易的确认是需要时间的:
1. 你需要等待你的交易被矿工打包成区块链
2. 你需要等待一段时间, 直到包含你交易的区块链达到足够的长度, 这时候你放心了, 因为:
  1. 区块链是不能被篡改的
  1. 这条链包含了许多工作量, 其他链的长度很难超过它

以上所提到的模型, 便是中本聪在论文中描述的.
使用这套方法, 本质上我们不再需要信任权威的第三方机构, 我们只信任计算量.

### POW可靠吗?

{% asset_img attack.png 假链攻击 %}

关于假链攻击的生动的描述.

### 挖矿难度

我们先回顾一下本章所学的一些基本概念:
- 数字签名
- 去中心化(分布式账本)
- 工作量证明(POW)
- 区块链

刚刚我们在讲工作量证明时一直提到30个零, 其实也未必就必须是30个, 这个数值决定了挖矿行为的难度. 
这个难度会根据全网的算力来进行调整, 以维持出块速度的稳定.

不同的数字货币的挖矿难度不尽相同, 因此他们的出块时间也不一样, 每秒钟能处理的交易数量也是不同的.

{% asset_img blockTime.png 平均出块时间 %}

另外, 由于挖矿奖励的币是凭空产生的, 为了防止通货膨胀, 所有的数字货币都有奖励减少的规则(例如比特币是每4年减半).

{% asset_img blockReward.png 比特币的区块奖励 %}

深谙数学的你便想到了, 这样子比特币的发行量是有上限的, 我们来计算一下.

> BTC创世的时候发行量为0
> BTC出块速度约为10分钟
> 前4年出块量 = 60 * 24 * 365 / 10 * 4 = 5.265w * 4 = 21.06w
> 前4年发行量 = 前4年出块量 * 50 = 1053w
> 总发行量 = 前4年发行量 * 2 = 2106w

# 更多科普文

1. [关于全节点和轻节点(默克尔树)]()
1. [如何购买我的第一个数字货币]()
1. [什么是硬分叉和软分叉: ETH和ETC的故事]()













